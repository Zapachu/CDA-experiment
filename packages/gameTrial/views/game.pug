html
    head
        meta(charset="utf-8")
        meta(http-equiv='X-UA-Compatible', content='IE=edge')
        meta(name="viewport", content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no")
        meta(name='author', content='微课研')
        meta(name="description", content="微课研是社会科学领域全球领先的课程和研究管理平台。功能涵盖：被试招募, 被试库管理, 调查问卷, 课程管理, 在线实验, 推送通知, 实验定制, 博弈论实验, 报酬支付。实验经济学领域的高效工具，行为经济学研究的好帮手。管理学沙盘，心理学调查实验，等社科领域也可以适用。")
        meta(name="keywords", content="实验经济学平台, 被测试者, 被试招募, 被试库管理, 调查问卷, 课程管理, 推送通知, 实验平台, 经济学软件, 实验模型, 实验定制, 行为经济学, 实验经济学, 博弈论, 实验系统")
        title 微课研 - 实验经济学行为经济学宏观微观市场政策测试招募问卷调查在线实验教学研究平台
        style.
            html, body, div, span, applet, object, iframe,
            h1, h2, h3, h4, h5, h6, p, blockquote, pre,
            a, abbr, acronym, address, big, cite, code,
            del, dfn, em, img, ins, kbd, q, s, samp,
            small, strike, strong, sub, sup, tt, var,
            b, u, i, center,
            dl, dt, dd, ol, ul, li,
            fieldset, form, label, legend,
            table, caption, tbody, tfoot, thead, tr, th, td,
            article, aside, canvas, details, embed,
            figure, figcaption, footer, header, hgroup,
            menu, nav, output, ruby, section, summary,
            time, mark, audio, video {
                margin: 0;
                padding: 0;
                border: 0;
                font-size: 100%;
                font: inherit;
                vertical-align: baseline;
            }

            /* HTML5 display-role reset for older browsers */
            article, aside, details, figcaption, figure,
            footer, header, hgroup, menu, nav, section {
                display: block;
            }

            body {
                line-height: 1;
            }

            ol, ul {
                list-style: none;
            }

            blockquote, q {
                quotes: none;
            }

            blockquote:before, blockquote:after,
            q:before, q:after {
                content: '';
                content: none;
            }

            table {
                border-collapse: collapse;
                border-spacing: 0;
            }
        style.
            body {
                background-color: #eff3f5;
            }
            .gameTitle {
                margin: 99px 0 0;
                text-align: center;
                line-height: 1.3;
                color: #F55B7D;
                font-size: 48px;
            }
            .startBtn {
                position: fixed;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                cursor: pointer;
                filter: grayscale(50%);
            }
            .startBtn:hover {
                filter: none;
            }
            .matchModal {
              display: none;
            }
            .matchModal >.main {
              background-color: #fff;
              width: 16rem;
              padding: 1rem;
              border-radius: .5rem;
            }
            .matchModal >.main >.header {
              text-align: center;
              padding: 10px;
              border-bottom: 1px solid rgba(155, 155, 155, 0.2);
            }
            .matchModal >.main >.players {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 20px 10px;
            }
            .matchModal >.main >.players >.player1 .playerOpacity {
              animation: 4s steps(1, start) 0s infinite playerOpacity1;
            }
            .matchModal >.main >.players >.player2 .playerOpacity {
              animation: 4s steps(1, start) 0s infinite playerOpacity2;
            }
            .matchModal >.main >.players >.player3 .playerOpacity {
              animation: 4s steps(1, start) 0s infinite playerOpacity3;
            }
            .matchModal >.main >.players >.player4 .playerOpacity {
              animation: 4s steps(1, start) 0s infinite playerOpacity4;
            }
            .continueGameModal {
                display: none;
            }
            .continueGameModal .main{
                background-color: white;
            }
            .continueGameModal .content {
                padding: 1rem;
            }
            .continueGameModal .headerBox {
                display: flex;
                justify-content: space-between;
                align-items: center;
                line-height: 4rem;
                padding: 0 1.4rem;
                border-bottom: 1px solid rgba(155, 155, 155, 0.5);
            }

            .continueGameModal .headerBox .title {
                font-size: 24px;
            }

            .continueGameModal .headerBox .close {
                font-size: 28px;
                cursor: pointer;
                color: #676B6F;
            }

            .continueGameModal .headerBox .close:hover {
                color: black;
            }

            .continueGameModal .continueBtn {
                border: 1px solid #3482e9;
                background-color: #3482e9;
                color: white;
            }
            .continueGameModal .continueBtn:hover {
                border: 1px solid #5892de;
                background-color: #5892de;
            }
            .continueGameModal .restartBtn {
                border: 1px solid #3482e9;
                color: #3482e9;
            }
            .continueGameModal .btns .btnBase + .btnBase {
                margin-left: 1rem;
            }
            .continueGameModal .btns {
                text-align: right;
                padding-right: 1rem;
                padding-bottom: 1rem;
            }
            .content {
              max-width: 24rem;
              margin: 1rem 1rem;
            }
            .content .cover {
              position: relative;
              overflow: hidden;
              border-radius: 1rem;
              margin-bottom:1rem;
              box-shadow: 0 3px 4px -3px #000;
            }
            .content .cover > img {
              width: 100%;
            }
            .content .cover .mask {
              right: 0;
              bottom: 0;
              left: 0;
              height: 17%;
              position: absolute;
              bottom: 0;
              display: flex;
              padding: 3%;
              box-sizing: border-box;
              pointer-events: none;
              cursor: pointer;
              -webkit-tap-highlight-color: transparent;
            }
            .content .cover .mask .shade {
              position: absolute;
              top: 0;
              right: 0;
              bottom: 0;
              left: 0;
              opacity: .5;
              background-color: #000;
            }
            .content .cover .mask >img {
              height: 100%;
              z-index: 10;
            }
            .content .cover .mask .desc {
              color: #fff;
              padding-left: 4%;
              font-size: 14px;
              z-index: 10;
            }
            .content .cover .mask .desc .title {
              font-size: 16px;
              margin: 5px 0 8px 0;
            }
            .rule .title {
              font-size: 20px;
              font-weight: bold;
              color: #333333;
              margin-bottom: 10px;
            }
            .ellipsis {
              position: relative;
              max-height: 66px;
              line-height: 22px;
              overflow: hidden;
              cursor: pointer;
              -webkit-tap-highlight-color: transparent;
            }
            .ellipsis .container {
              position: relative;
              display: -webkit-box;
              -webkit-box-orient: vertical;
              -webkit-line-clamp: 3;
              font-size: 38.5px;
              color: transparent;
            }
            .ellipsis .word {
              color: #666666;
              display: inline;
              vertical-align: top;
              font-size: 14px;
            }
            .ellipsis .ghost {
              position:absolute;
              z-index: 1;
              top: 0;
              width: 100%;
              height: 100%;
            }
            .ellipsis .ghost:before {
                content: "";
                display: block;
                float: right;
                width: 50%;
                height: 100%;
            }
            .ellipsis .placeholder {
                content: "";
                display: block;
                float: right;
                width: 50%;
                height: 100%;
            }
            .ellipsis .more {
                float: right;
                font-size: 14px;
                margin-top: -20px;
                color: #4A75FF;
            }
            .startButton {
              max-width: 10rem;
              margin: 2rem auto 0;
              background-color: #4A75FF;
              border-radius: 2rem;
              text-align: center;
              font-size: 1.25rem;
              padding: .75rem;
              color: #fff;
              box-sizing: border-box;
              cursor: pointer;
              -webkit-tap-highlight-color: transparent;
            }
            .scrollHolder {
              overflow: hidden;
            }
            .scrollHolder >.scroll {
              transition: transform 0.5s ease;
            }
            @keyframes playerOpacity1 {
                from {
                  opacity: 0;
                }
                20% {
                  opacity: 0.3;
                }
                40% {
                  opacity: 1;
                }
                60% {
                  opacity: 1;
                }
                80% {
                  opacity: 1;
                }
                100% {
                  opacity: 1;
                }
            }
            @keyframes playerOpacity2 {
                from {
                  opacity: 0;
                }
                20% {
                  opacity: 0.3;
                }
                40% {
                  opacity: 0.3;
                }
                60% {
                  opacity: 1;
                }
                80% {
                  opacity: 1;
                }
                100% {
                  opacity: 1;
                }
            }
            @keyframes playerOpacity3 {
                from {
                  opacity: 0;
                }
                20% {
                  opacity: 0.3;
                }
                40% {
                  opacity: 0.3;
                }
                60% {
                  opacity: 0.3;
                }
                80% {
                  opacity: 1;
                }
                100% {
                  opacity: 1;
                }
            }
            @keyframes playerOpacity4 {
                from {
                  opacity: 0;
                }
                20% {
                  opacity: 0.3;
                }
                40% {
                  opacity: 0.3;
                }
                60% {
                  opacity: 0.3;
                }
                80% {
                  opacity: 0.3;
                }
                100% {
                  opacity: 1;
                }
            }
        style
            include login/style.css
        style
            include message/style.css
        style
            include modal/modal.css
    body
        include  login/html
        //- h3.gameTitle=`${game.name}`
        //- img(src=`${rootname}/static/start_button_icon.png` class="startBtn")
        .content
          .scrollHolder
            .scroll
              .cover
                img(src=`${game.coverImg}`)
                .mask
                  .shade
                  img(src=`${game.coverImg}`)
                  .desc
                    p.title #{game.name}
                    p #{game.nameEn}
              .rule
                p.title 游戏规则
                .ellipsis
                  .container
                    .word #{game.desc}
                    .ghost
                      .placeholder
                      .more ...更多
          .startButton 开始
        div.matchModal
          .main
            p.header 匹配中...
            ul.players
              each num in [1, 2, 3, 4]
                li(class=`player${num}`)
                  svg(width="45px" height="54px" viewBox="0 0 70 84" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns-xlink="http://www.w3.org/1999/xlink")
                    defs
                      radial-gradient(cx="50%" cy="0%" fx="50%" fy="0%" r="160.114698%" gradientTransform="translate(0.500000,0.000000),scale(1.000000,0.833333),rotate(90.000000),translate(-0.500000,-0.000000)")
                        stop(stop-color="#FFFFFF" offset="0%")
                        stop(stop-color="#000000" stop-opacity="0" offset="100%")
                    g.playerOpacity(stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" opacity="0.3")
                      g(transform="translate(-457.000000, -483.000000)")
                        g(transform="translate(380.000000, 343.000000)")
                          g(transform="translate(77.000000, 140.000000)")
                            rect.playerBgColor(stroke="url(#radialGradient-1)" fill="#4A75FF" fill-rule="nonzero" x="1.5" y="6" width="70" height="70" rx="12")
                            g(transform="translate(7.000000, 14.000000)")
                              rect(fill="#000000" opacity="0" x="0" y="0" width="59" height="59")
                              path.playerColor(d="M49.9597814,49.448604 C49.9712724,49.4140478 50,49.3794917 50,49.3506949 C50,49.2931013 49.9597814,49.2355077 49.9310538,49.1779141 C49.8276345,48.3485664 49.6380325,47.5364968 49.3047926,46.7647427 C48.6670404,45.2097158 47.4604821,43.9484162 46.0815583,43.0211594 C43.3524383,41.1320896 40.0257848,40.4294479 37.1587724,38.7995493 C36.2050168,38.217854 35.2397702,37.463378 34.8663117,36.3633404 C34.6882007,34.8543884 34.7514013,33.3339176 34.7571469,31.8249656 C35.2684978,31.4390885 35.6132287,30.8919494 35.9234865,30.339051 C36.5612388,29.1641417 37.0036435,27.8798047 37.1875,26.5551521 C37.6528868,26.4630024 38.0608184,26.1807938 38.3251121,25.7891574 C38.8192265,25.0519594 38.9973374,24.1534994 39.0777747,23.2895956 C39.1524664,22.5236009 38.847954,21.7345687 38.2389294,21.2623012 C38.9915919,18.7454614 39.5201794,16.1019156 39.2443946,13.4641292 C39.0835202,11.8975836 38.5376962,10.2907224 37.35412,9.20220358 C36.5382567,8.44772756 35.4523543,8.05609115 34.3721973,7.88906974 C34.1079036,7.49167397 33.7746637,7.13459371 33.3609865,6.88694128 C32.2463565,6.20157756 30.9076513,6.02303744 29.6264013,6 C27.3569226,6.03455615 24.9667881,6.4204332 23.09375,7.79116064 C22.1572309,8.46500563 21.4103139,9.39226243 20.910454,10.4347064 C20.3014294,11.7075247 20.0428812,13.1300864 19.985426,14.53537 C19.8934978,16.8103168 20.2956839,19.0679855 20.8415078,21.2680606 C20.2669563,21.7172906 19.9566984,22.4544885 19.996917,23.1801678 C20.0428812,23.9000876 20.1865191,24.6200075 20.4737948,25.2880932 C20.7265975,25.8985852 21.2207119,26.4514837 21.8929372,26.5724302 C22.0653027,27.8222111 22.4904709,29.0316765 23.082259,30.1489921 C23.4269899,30.7710029 23.8061939,31.4045324 24.3807455,31.8364843 C24.3807455,33.3511957 24.4439462,34.8716665 24.2658352,36.3806185 C23.8004484,37.7110304 22.536435,38.5173407 21.3586043,39.1508702 C18.7788677,40.4524853 15.940583,41.201202 13.4700112,42.7274321 C12.4013453,43.4127958 11.384389,44.2248654 10.6317265,45.26155 C9.82160874,46.3615876 9.367713,47.6804808 9.1838565,49.0281708 C9.0746917,49.1375986 9,49.2470264 9,49.3622136 C9,49.4543633 9.04021861,49.5465131 9.1091648,49.6329035 C9.10341928,49.7020158 9.09192825,49.7653687 9.08618274,49.8287217 L9.33898543,49.8287217 C11.0626401,51.0612245 19.4223655,52 29.4942545,52 C39.5776345,52 47.9373599,51.0612245 49.6552691,49.8229623 L49.9942545,49.8229623 C49.988509,49.6962564 49.9712724,49.5753099 49.9597814,49.448604 Z" fill="#ffffff")
                //- img(src=`${rootname}/static/person_icon.gif`)
                //- div.board
                //-     img(src=`${rootname}/static/input_icon.png`)
                //-     p.label 游戏正在人员匹配<br>请耐心等待
                      
                //- div.matchLoading
                //-     img(src=`${rootname}/static/loading_icon.png`)
                //-     span.label="匹配中"
        div.continueGameModal
            div.main
                .headerBox
                    h3(class="title") 提醒
                    span.close ×
                div.content 检测到已有实验进行中，是否继续?
                div.btns
                    div(class="btnBase continueBtn") 继续
                    div(class="btnBase restartBtn") 重新开始
        script(type="text/javascript" src="https://qiniu1.anlint.com/js/jquery.min.js")
        script(type="text/javascript" src=`${rootname}/static/js/socket.io.js`)
        script
            include  login/script.js
        script
            include  modal/modal.js
        script
            include  message/script.js
        script.
            var clientSocketListenEvnets = {
                startMatch: 'startMatch',
                startGame: 'startGame',
                continueGame: 'continueGame',
                handleError: 'handleError' 
            }
            var serverSocketListenEvents = {
                reqStartGame:'reqStartGame',
                leaveMatchRoom:'leaveMatchRoom'
            }
            var connection
            var gameObjStr = '!{JSON.stringify(game)}'
            var game = JSON.parse(gameObjStr)
            var rootname = '!{rootname}'
            var namespace = '!{namespace}'
            var continueGameBox = Modal('.continueGameModal', {maskCloseable: true})
            $('.continueGameModal .close').click(continueGameBox.close)
            const matchModal = Modal('.matchModal');

            function connectInit () {
                connection = io('/', {
                    path: rootname + '/socket'
                })
                connection.on('connect', (socket) => {
                    console.log('io connected')
                    connection.emit(serverSocketListenEvents.reqStartGame, {
                        isGroupMode: true, 
                        gamePhase: game.type
                    })
                    //- $('.startBtn').hide()
                    $('.matchModal').show()
                })
                // TODO
                connection.on(clientSocketListenEvnets.startMatch, () => {
                    console.log('recive startmatch')
                })
                connection.on(clientSocketListenEvnets.startGame, ({ playerUrl }) => {
                    message.success('匹配成功')
                    setTimeout(function () {
                        location = playerUrl
                    }, 1500)
                })
                connection.on(clientSocketListenEvnets.continueGame, ({ playerUrl }) => {
                    continueGameBox.open()
                    function restart () {
                         connection.emit(serverSocketListenEvents.reqStartGame, {
                            isGroupMode: true, 
                            gamePhase: game.type,
                            isForce: true
                        })
                    }
                    function handleContinue () {
                        setTimeout(function () {
                            location = playerUrl
                        }, 1500)
                    }
                    $('.continueGameModal .btns .restartBtn').click(restart)
                    $('.continueGameModal .btns .continueBtn').click(handleContinue)
                })
                connection.on(clientSocketListenEvnets.handleError, (data) => {
                    const { eventType, msg } = data
                    if (eventType === serverSocketListenEvents.reqStartGame) {
                        // Todo
                        message.error(msg)
                    }
                    if (eventType === serverSocketListenEvents.leaveMatchRoom) {
                        // TODO
                        message.error(msg)
                    }
                })
            }

            function initWx () {
                 if(navigator.userAgent.toLowerCase().includes('micromessenger')) {
                    $.ajax({
                        type: 'GET',
                        url: "/wechat/jssdk?url=" + encodeURIComponent(window.location.href),
                        success: function ({err, msg}) {
                            if (err !== 0) {
                                return console.error(msg)
                            }
                            wx.config({
                                debug: false,
                                appId: msg.appId,
                                timestamp: msg.timestamp,
                                nonceStr: msg.nonceStr,
                                signature: msg.signature,
                                jsApiList: [ 'updateAppMessageShareData', 'updateTimelineShareData ' ]
                            })

                            wx.ready(function () {
                                const defaultObj = {
                                    title: '微课研-' + game.name + ' 体验互动实验，感受经济学魅力',
                                    link: location.href,
                                    imgUrl: location.href.replace(/\/$/, '') + game.img
                                }
                                wx.updateTimelineShareData(defaultObj)
                                wx.updateAppMessageShareData(Object.assign({desc: game.desc}, defaultObj))
                            })
                        }
                    })
                }

            }

            window.onload = function () {
                var inWx = /micromessenger/.test(navigator.userAgent.toLowerCase())
                var isLogin = !{isLogin}
                var _csrf = '!{_csrf}'
                
                var loginBox = LoginInit(_csrf, null, null, function () {
                    isLogin = true
                    startGame()
                });

                initWx()

                function startGame (e) {
                  //- $('.matchModal').show();
                  //- return;
                    e && e.stopPropagation()
                    if (isLogin) {
                        connectInit()
                    } else {
                        // TODO
                        if (inWx) {
                            location.href = namespace + '/account/wxlogin?redirect=' + encodeURI(location.href)
                            return
                        }
                        message.warn('请先登录')
                        loginBox.show()
                    }
                }

                $('.startButton').click(startGame)
            }

            attachListeners();

            function attachListeners() {
              const distance = $('.content .cover >img').height()*0.83;
              const $ellipsis = $('.ellipsis');
              const $scroll = $('.scrollHolder .scroll');
              const $ellipsisContainer = $('.ellipsis .container');
              const $ellipsisGhost = $('.ellipsis .ghost');
              const $mask = $('.content .cover .mask');
              window.$mask = $mask;
              $ellipsis.click(function() {
                $scroll.css('transform', `translateY(-${distance}px)`);
                $ellipsis.css('overflow', 'unset');
                $ellipsisContainer.removeClass('container');
                $ellipsisGhost.hide();
                $ellipsis.css('pointer-events', 'none');
                $mask.css('pointer-events', 'unset');
              })
              $mask.click(function() {
                $scroll.css('transform', `translateY(0px)`);
                $ellipsis.css('overflow', 'hidden');
                $ellipsisContainer.addClass('container');
                $ellipsisGhost.show();
                $mask.css('pointer-events', 'none');
                $ellipsis.css('pointer-events', 'unset');
              })
            }
